var __decorate=this&&this.__decorate||function(e,s,t,i){var o,l=arguments.length,r=l<3?s:null===i?i=Object.getOwnPropertyDescriptor(s,t):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,s,t,i);else for(var n=e.length-1;n>=0;n--)(o=e[n])&&(r=(l<3?o(r):l>3?o(s,t,r):o(s,t))||r);return l>3&&r&&Object.defineProperty(s,t,r),r};import{html}from"lit";import{customElement,property,query,queryAll,queryAssignedElements,state}from"lit/decorators.js";import{classMap}from"lit/directives/class-map.js";import{styleMap}from"lit/directives/style-map.js";import{VscElement}from"../includes/VscElement.js";import"../vscode-scrollable";import{rawValueToPercentage}from"./helpers.js";import styles from"./vscode-table.styles.js";const COMPONENT_WIDTH_PERCENTAGE=100;let VscodeTable=class extends VscElement{constructor(){super(...arguments),this.role="table",this.resizable=!1,this.responsive=!1,this.breakpoint=300,this.minColumnWidth="50px",this.delayedResizing=!1,this.compact=!1,this._sashPositions=[],this._isDragging=!1,this._sashHovers=[],this._columns=[],this._activeSashElementIndex=-1,this._activeSashCursorOffset=0,this._componentX=0,this._componentH=0,this._componentW=0,this._headerCells=[],this._cellsOfFirstRow=[],this._prevHeaderHeight=0,this._prevComponentHeight=0,this._componentResizeObserverCallback=()=>{this._memoizeComponentDimensions(),this._updateResizeHandlersSize(),this.responsive&&this._toggleCompactView()},this._headerResizeObserverCallback=()=>{this._updateResizeHandlersSize()},this._bodyResizeObserverCallback=()=>{let e=0,s=0;const t=this.getBoundingClientRect().height;this._assignedHeaderElements&&this._assignedHeaderElements.length&&(e=this._assignedHeaderElements[0].getBoundingClientRect().height),this._assignedBodyElements&&this._assignedBodyElements.length&&(s=this._assignedBodyElements[0].getBoundingClientRect().height);const i=s-e-t;this._scrollableElement.style.height=i>0?t-e+"px":"auto"},this._onResizingMouseMove=e=>{e.stopPropagation(),this._updateActiveSashPosition(e.pageX),this.delayedResizing?this._resizeColumns(!1):this._resizeColumns(!0)},this._onResizingMouseUp=e=>{this._resizeColumns(!0),this._updateActiveSashPosition(e.pageX),this._sashHovers[this._activeSashElementIndex]=!1,this._isDragging=!1,this._activeSashElementIndex=-1,document.removeEventListener("mousemove",this._onResizingMouseMove),document.removeEventListener("mouseup",this._onResizingMouseUp)}}set columns(e){this._columns=e,this.isConnected&&this._initDefaultColumnSizes()}get columns(){return this._columns}connectedCallback(){super.connectedCallback(),this._memoizeComponentDimensions(),this._initDefaultColumnSizes()}disconnectedCallback(){super.disconnectedCallback(),this._componentResizeObserver.unobserve(this),this._componentResizeObserver.disconnect(),this._bodyResizeObserver?.disconnect()}_px2Percent(e){return e/this._componentW*100}_percent2Px(e){return this._componentW*e/100}_memoizeComponentDimensions(){const e=this.getBoundingClientRect();this._componentH=e.height,this._componentW=e.width,this._componentX=e.x}_queryHeaderCells(){const e=this._assignedHeaderElements;return e&&e[0]?Array.from(e[0].querySelectorAll("vscode-table-header-cell")):[]}_getHeaderCells(){return this._headerCells.length||(this._headerCells=this._queryHeaderCells()),this._headerCells}_queryCellsOfFirstRow(){const e=this._assignedBodyElements;return e&&e[0]?Array.from(e[0].querySelectorAll("vscode-table-row:first-child vscode-table-cell")):[]}_getCellsOfFirstRow(){return this._cellsOfFirstRow.length||(this._cellsOfFirstRow=this._queryCellsOfFirstRow()),this._cellsOfFirstRow}_initResizeObserver(){this._componentResizeObserver=new ResizeObserver(this._componentResizeObserverCallback),this._componentResizeObserver.observe(this),this._headerResizeObserver=new ResizeObserver(this._headerResizeObserverCallback),this._headerResizeObserver.observe(this._headerElement)}_calcColWidthPercentages(){const e=this._getHeaderCells().length;let s=this.columns.slice(0,e);const t=s.filter((e=>"auto"===e)).length+e-s.length;let i=100;if(s=s.map((e=>{const s=rawValueToPercentage(e,this._componentW);return null===s?"auto":(i-=s,s)})),s.length<e)for(let t=s.length;t<e;t++)s.push("auto");return s=s.map((e=>"auto"===e?i/t:e)),s}_initHeaderCellSizes(e){this._getHeaderCells().forEach(((s,t)=>{s.style.width=`${e[t]}%`}))}_initBodyColumnSizes(e){this._getCellsOfFirstRow().forEach(((s,t)=>{s.style.width=`${e[t]}%`}))}_initSashes(e){const s=e.length;let t=0;this._sashPositions=[],e.forEach(((e,i)=>{if(i<s-1){const s=t+e;this._sashPositions.push(s),t=s}}))}_initDefaultColumnSizes(){const e=this._calcColWidthPercentages();this._initHeaderCellSizes(e),this._initBodyColumnSizes(e),this._initSashes(e)}_updateResizeHandlersSize(){const e=this._headerElement.getBoundingClientRect();if(e.height===this._prevHeaderHeight&&this._componentH===this._prevComponentHeight)return;this._prevHeaderHeight=e.height,this._prevComponentHeight=this._componentH;const s=this._componentH-e.height;this._sashVisibleElements.forEach((t=>{t.style.height=`${s}px`,t.style.top=`${e.height}px`}))}_applyCompactViewColumnLabels(){const e=this._getHeaderCells().map((e=>e.innerText));this.querySelectorAll("vscode-table-row").forEach((s=>{s.querySelectorAll("vscode-table-cell").forEach(((s,t)=>{s.columnLabel=e[t],s.compact=!0}))}))}_clearCompactViewColumnLabels(){this.querySelectorAll("vscode-table-cell").forEach((e=>{e.columnLabel="",e.compact=!1}))}_toggleCompactView(){const e=this.getBoundingClientRect().width<this.breakpoint;this.compact!==e&&(this.compact=e,e?this._applyCompactViewColumnLabels():this._clearCompactViewColumnLabels())}_onHeaderSlotChange(){this._headerCells=this._queryHeaderCells()}_onBodySlotChange(){if(this._initDefaultColumnSizes(),this._initResizeObserver(),this._updateResizeHandlersSize(),!this._bodyResizeObserver){const e=this._assignedBodyElements[0]??null;e&&(this._bodyResizeObserver=new ResizeObserver(this._bodyResizeObserverCallback),this._bodyResizeObserver.observe(e))}}_onSashMouseOver(e){if(this._isDragging)return;const s=e.currentTarget,t=Number(s.dataset.index);this._sashHovers[t]=!0,this.requestUpdate()}_onSashMouseOut(e){if(e.stopPropagation(),this._isDragging)return;const s=e.currentTarget,t=Number(s.dataset.index);this._sashHovers[t]=!1,this.requestUpdate()}_onSashMouseDown(e){e.stopPropagation();const{pageX:s,currentTarget:t}=e,i=t,o=Number(i.dataset.index),l=i.getBoundingClientRect().x;this._isDragging=!0,this._activeSashElementIndex=o,this._sashHovers[this._activeSashElementIndex]=!0,this._activeSashCursorOffset=this._px2Percent(s-l);const r=this._getHeaderCells();this._headerCellsToResize=[],this._headerCellsToResize.push(r[o]),r[o+1]&&(this._headerCellsToResize[1]=r[o+1]);const n=this._bodySlot.assignedElements()[0].querySelectorAll("vscode-table-row:first-child > vscode-table-cell");this._cellsToResize=[],this._cellsToResize.push(n[o]),n[o+1]&&this._cellsToResize.push(n[o+1]),document.addEventListener("mousemove",this._onResizingMouseMove),document.addEventListener("mouseup",this._onResizingMouseUp)}_updateActiveSashPosition(e){const{prevSashPos:s,nextSashPos:t}=this._getSashPositions();let i=rawValueToPercentage(this.minColumnWidth,this._componentW);null===i&&(i=0);const o=s?s+i:i,l=t?t-i:100-i;let r=this._px2Percent(e-this._componentX-this._percent2Px(this._activeSashCursorOffset));r=Math.max(r,o),r=Math.min(r,l),this._sashPositions[this._activeSashElementIndex]=r,this.requestUpdate()}_getSashPositions(){return{sashPos:this._sashPositions[this._activeSashElementIndex],prevSashPos:this._sashPositions[this._activeSashElementIndex-1]||0,nextSashPos:this._sashPositions[this._activeSashElementIndex+1]||100}}_resizeColumns(e=!0){const{sashPos:s,prevSashPos:t,nextSashPos:i}=this._getSashPositions(),o=s-t+"%",l=i-s+"%";this._headerCellsToResize[0].style.width=o,this._headerCellsToResize[1]&&(this._headerCellsToResize[1].style.width=l),e&&(this._cellsToResize[0].style.width=o,this._cellsToResize[1]&&(this._cellsToResize[1].style.width=l))}render(){const e=this._sashPositions.map(((e,s)=>{const t=classMap({sash:!0,hover:this._sashHovers[s],resizable:this.resizable}),i=`${e}%`;return this.resizable?html`
            <div
              class="${t}"
              data-index="${s}"
              style="${styleMap({left:i})}"
              @mousedown="${this._onSashMouseDown}"
              @mouseover="${this._onSashMouseOver}"
              @mouseout="${this._onSashMouseOut}"
            >
              <div class="sash-visible"></div>
              <div class="sash-clickable"></div>
            </div>
          `:html`<div
            class="${t}"
            data-index="${s}"
            style="${styleMap({left:i})}"
          >
            <div class="sash-visible"></div>
          </div>`})),s=classMap({wrapper:!0,"select-disabled":this._isDragging,"resize-cursor":this._isDragging,"compact-view":this.compact});return html`
      <div class="${s}">
        <div class="header" @slotchange="${this._onHeaderSlotChange}">
          <slot name="caption"></slot>
          <div class="header-slot-wrapper">
            <slot name="header"></slot>
          </div>
        </div>
        <vscode-scrollable class="scrollable">
          <div>
            <slot name="body" @slotchange="${this._onBodySlotChange}"></slot>
          </div>
        </vscode-scrollable>
        ${e}
      </div>
    `}};VscodeTable.styles=styles,__decorate([property({reflect:!0})],VscodeTable.prototype,"role",void 0),__decorate([property({type:Boolean,reflect:!0})],VscodeTable.prototype,"resizable",void 0),__decorate([property({type:Boolean,reflect:!0})],VscodeTable.prototype,"responsive",void 0),__decorate([property({type:Number})],VscodeTable.prototype,"breakpoint",void 0),__decorate([property({type:Array})],VscodeTable.prototype,"columns",null),__decorate([property({attribute:"min-column-width"})],VscodeTable.prototype,"minColumnWidth",void 0),__decorate([property({type:Boolean,reflect:!0,attribute:"delayed-resizing"})],VscodeTable.prototype,"delayedResizing",void 0),__decorate([property({type:Boolean,reflect:!0})],VscodeTable.prototype,"compact",void 0),__decorate([query('slot[name="body"]')],VscodeTable.prototype,"_bodySlot",void 0),__decorate([query(".header")],VscodeTable.prototype,"_headerElement",void 0),__decorate([query(".scrollable")],VscodeTable.prototype,"_scrollableElement",void 0),__decorate([queryAll(".sash-visible")],VscodeTable.prototype,"_sashVisibleElements",void 0),__decorate([queryAssignedElements({slot:"header",flatten:!0,selector:"vscode-table-header"})],VscodeTable.prototype,"_assignedHeaderElements",void 0),__decorate([queryAssignedElements({slot:"body",flatten:!0,selector:"vscode-table-body"})],VscodeTable.prototype,"_assignedBodyElements",void 0),__decorate([state()],VscodeTable.prototype,"_sashPositions",void 0),__decorate([state()],VscodeTable.prototype,"_isDragging",void 0),VscodeTable=__decorate([customElement("vscode-table")],VscodeTable);export{VscodeTable};