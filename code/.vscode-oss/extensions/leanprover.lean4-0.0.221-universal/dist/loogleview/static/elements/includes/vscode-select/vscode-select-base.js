var __decorate=this&&this.__decorate||function(e,t,o,s){var i,n=arguments.length,r=n<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,o):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,o,s);else for(var d=e.length-1;d>=0;d--)(i=e[d])&&(r=(n<3?i(r):n>3?i(t,o,r):i(t,o))||r);return n>3&&r&&Object.defineProperty(t,o,r),r};import{html,nothing}from"lit";import{property,query,queryAssignedElements,state}from"lit/decorators.js";import{classMap}from"lit/directives/class-map.js";import"../../vscode-button";import"../../vscode-option";import{filterOptionsByPattern}from"./helpers.js";import{VscElement}from"../VscElement.js";const VISIBLE_OPTS=10,OPT_HEIGHT=22,LIST_HEIGHT=34;export class VscodeSelectBase extends VscElement{constructor(){super(...arguments),this.ariaExpanded="false",this.combobox=!1,this.invalid=!1,this.focused=!1,this.position="below",this.tabIndex=0,this._activeIndex=-1,this._currentDescription="",this._filter="fuzzy",this._filterPattern="",this._selectedIndex=-1,this._selectedIndexes=[],this._showDropdown=!1,this._options=[],this._value="",this._values=[],this._listScrollTop=0,this._multiple=!1,this._valueOptionIndexMap={},this._isHoverForbidden=!1,this._disabled=!1,this._originalTabIndex=void 0,this._onClickOutside=e=>{-1===e.composedPath().findIndex((e=>e===this))&&(this._toggleDropdown(!1),window.removeEventListener("click",this._onClickOutside))},this._onMouseMove=()=>{this._isHoverForbidden=!1,window.removeEventListener("mousemove",this._onMouseMove)}}set disabled(e){this._disabled=e,this.ariaDisabled=e?"true":"false",!0===e?(this._originalTabIndex=this.tabIndex,this.tabIndex=-1):(this.tabIndex=this._originalTabIndex??0,this._originalTabIndex=void 0),this.requestUpdate()}get disabled(){return this._disabled}set filter(e){["contains","fuzzy","startsWith","startsWithPerTerm"].includes(e)?this._filter=e:(this._filter="fuzzy",console.warn(`[VSCode Webview Elements] Invalid filter: "${e}", fallback to default. Valid values are: "contains", "fuzzy", "startsWith", "startsWithPerm".`,this))}get filter(){return this._filter}set options(e){this._options=e.map(((e,t)=>({...e,index:t})))}get options(){return this._options.map((({label:e,value:t,description:o,selected:s,disabled:i})=>({label:e,value:t,description:o,selected:s,disabled:i})))}connectedCallback(){super.connectedCallback(),this.addEventListener("keydown",this._onComponentKeyDown),this.addEventListener("focus",this._onComponentFocus),this.addEventListener("blur",this._onComponentBlur)}disconnectedCallback(){super.disconnectedCallback(),this.removeEventListener("keydown",this._onComponentKeyDown),this.removeEventListener("focus",this._onComponentFocus),this.removeEventListener("blur",this._onComponentBlur)}get _filteredOptions(){return this.combobox&&""!==this._filterPattern?filterOptionsByPattern(this._options,this._filterPattern,this._filter):this._options}get _currentOptions(){return this.combobox?this._filteredOptions:this._options}_addOptionsFromSlottedElements(){const e=[];let t=0;const o=this._assignedOptions??[],s={selectedIndexes:[],values:[]};return this._valueOptionIndexMap={},o.forEach((o=>{const{innerText:i,description:n,disabled:r}=o,d=o.value?o.value:i.trim(),l=o.selected??!1,c={label:i.trim(),value:d,description:n,selected:l,index:t,disabled:r};t=e.push(c),l&&(s.selectedIndexes.push(e.length-1),s.values.push(d)),this._valueOptionIndexMap[c.value]=c.index})),this._options=e,s}async _toggleDropdown(e){this._showDropdown=e,this.ariaExpanded=String(e),!e||this._multiple||this.combobox||(this._activeIndex=this._selectedIndex,this._activeIndex>9&&(await this.updateComplete,this._listElement.scrollTop=Math.floor(22*this._activeIndex))),e?window.addEventListener("click",this._onClickOutside):window.removeEventListener("click",this._onClickOutside)}_dispatchChangeEvent(){this._multiple?this.dispatchEvent(new CustomEvent("vsc-change",{detail:{selectedIndexes:this._selectedIndexes,value:this._values}})):this.dispatchEvent(new CustomEvent("vsc-change",{detail:{selectedIndex:this._selectedIndex,value:this._value}})),this.dispatchEvent(new Event("change"))}_onFaceClick(){this._toggleDropdown(!this._showDropdown),this._multiple&&(this._activeIndex=0)}_toggleComboboxDropdown(){this._filterPattern="",this._toggleDropdown(!this._showDropdown),this._multiple&&(this._activeIndex=-1)}_onComboboxButtonClick(){this._toggleComboboxDropdown()}_onComboboxButtonKeyDown(e){"Enter"===e.key&&this._toggleComboboxDropdown()}_onOptionMouseOver(e){if(this._isHoverForbidden)return;const t=e.target;t.matches(".option")&&(this._activeIndex=Number(this.combobox?t.dataset.filteredIndex:t.dataset.index))}_onEnterKeyDown(){const e=this.combobox?this._filteredOptions:this._options,t=!this._showDropdown;this._toggleDropdown(t),this._multiple||t||this._selectedIndex===this._activeIndex||(this._selectedIndex=e[this._activeIndex].index,this._value=this._options[this._selectedIndex].value,this._dispatchChangeEvent()),this.combobox&&(this._multiple||t||(this._selectedIndex=this._filteredOptions[this._activeIndex].index),!this._multiple&&t&&this.updateComplete.then((()=>{this._scrollActiveElementToTop()}))),this._multiple&&t&&(this._activeIndex=0)}_onSpaceKeyDown(){if(this._showDropdown){if(this._showDropdown&&this._multiple&&this._activeIndex>-1){const e=this.combobox?this._filteredOptions:this._options,{selected:t}=e[this._activeIndex];e[this._activeIndex].selected=!t,this._selectedIndexes=[],e.forEach((({index:e,selected:t})=>{t&&this._selectedIndexes.push(e)}))}}else this._toggleDropdown(!0)}_scrollActiveElementToTop(){this._listElement.scrollTop=Math.floor(22*this._activeIndex)}async _adjustOptionListScrollPos(e){if((this.combobox?this._filteredOptions.length:this._options.length)<=10)return;this._isHoverForbidden=!0,window.addEventListener("mousemove",this._onMouseMove),this._listElement||await this.updateComplete;const t=this._listElement.scrollTop,o=22*this._activeIndex;"down"===e&&o+22>=34+t&&(this._listElement.scrollTop=22*(this._activeIndex-9)),"up"===e&&o<=t-22&&this._scrollActiveElementToTop()}_onArrowUpKeyDown(){if(this._showDropdown){if(this._activeIndex<=0)return;this._activeIndex-=1,this._adjustOptionListScrollPos("up")}}_onArrowDownKeyDown(){if(this._showDropdown){if(this._activeIndex>=this._currentOptions.length-1)return;this._activeIndex+=1,this._adjustOptionListScrollPos("down")}}_onComponentKeyDown(e){[" ","ArrowUp","ArrowDown","Escape"].includes(e.key)&&(e.stopPropagation(),e.preventDefault()),"Enter"===e.key&&this._onEnterKeyDown()," "===e.key&&this._onSpaceKeyDown(),"Escape"===e.key&&this._toggleDropdown(!1),"ArrowUp"===e.key&&this._onArrowUpKeyDown(),"ArrowDown"===e.key&&this._onArrowDownKeyDown()}_onComponentFocus(){this.focused=!0}_onComponentBlur(){this.focused=!1}_onSlotChange(){const e=this._addOptionsFromSlottedElements();e.selectedIndexes.length>0&&(this._selectedIndex=e.selectedIndexes[0],this._selectedIndexes=e.selectedIndexes,this._value=e.values[0],this._values=e.values),this._multiple||this.combobox||0!==e.selectedIndexes.length||(this._selectedIndex=0),this.requestUpdate()}_onComboboxInputFocus(e){e.target.select()}_onComboboxInputInput(e){this._filterPattern=e.target.value,this._activeIndex=-1,this._toggleDropdown(!0)}_onComboboxInputClick(){this._toggleDropdown(!0)}_renderOptions(){return[]}_renderDescription(){if(!this._options[this._activeIndex])return nothing;const{description:e}=this._options[this._activeIndex];return e?html`<div class="description">${e}</div>`:nothing}_renderSelectFace(){return html`${nothing}`}_renderComboboxFace(){return html`${nothing}`}_renderDropdownControls(){return html`${nothing}`}_renderDropdown(){const e=classMap({dropdown:!0,multiple:this._multiple});return html`
      <div class="${e}">
        ${"above"===this.position?this._renderDescription():nothing}
        ${this._renderOptions()} ${this._renderDropdownControls()}
        ${"below"===this.position?this._renderDescription():nothing}
      </div>
    `}render(){return html`
      <slot class="main-slot" @slotchange="${this._onSlotChange}"></slot>
      ${this.combobox?this._renderComboboxFace():this._renderSelectFace()}
      ${this._showDropdown?this._renderDropdown():nothing}
    `}}__decorate([property({type:String,reflect:!0,attribute:"aria-expanded"})],VscodeSelectBase.prototype,"ariaExpanded",void 0),__decorate([property({type:Boolean,reflect:!0})],VscodeSelectBase.prototype,"combobox",void 0),__decorate([property({type:Boolean,reflect:!0})],VscodeSelectBase.prototype,"disabled",null),__decorate([property({type:Boolean,reflect:!0})],VscodeSelectBase.prototype,"invalid",void 0),__decorate([property()],VscodeSelectBase.prototype,"filter",null),__decorate([property({type:Boolean,reflect:!0})],VscodeSelectBase.prototype,"focused",void 0),__decorate([property({type:Array})],VscodeSelectBase.prototype,"options",null),__decorate([property({reflect:!0})],VscodeSelectBase.prototype,"position",void 0),__decorate([property({type:Number,attribute:!0,reflect:!0})],VscodeSelectBase.prototype,"tabIndex",void 0),__decorate([queryAssignedElements({flatten:!0,selector:"vscode-option"})],VscodeSelectBase.prototype,"_assignedOptions",void 0),__decorate([state()],VscodeSelectBase.prototype,"_activeIndex",void 0),__decorate([state()],VscodeSelectBase.prototype,"_currentDescription",void 0),__decorate([state()],VscodeSelectBase.prototype,"_filter",void 0),__decorate([state()],VscodeSelectBase.prototype,"_filteredOptions",null),__decorate([state()],VscodeSelectBase.prototype,"_filterPattern",void 0),__decorate([state()],VscodeSelectBase.prototype,"_selectedIndex",void 0),__decorate([state()],VscodeSelectBase.prototype,"_selectedIndexes",void 0),__decorate([state()],VscodeSelectBase.prototype,"_showDropdown",void 0),__decorate([state()],VscodeSelectBase.prototype,"_options",void 0),__decorate([state()],VscodeSelectBase.prototype,"_value",void 0),__decorate([state()],VscodeSelectBase.prototype,"_values",void 0),__decorate([state()],VscodeSelectBase.prototype,"_listScrollTop",void 0),__decorate([query(".options")],VscodeSelectBase.prototype,"_listElement",void 0);